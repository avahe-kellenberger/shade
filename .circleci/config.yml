# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: nimlang/nim
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: "Update the system"
          command: "apt-get update"
      - run:
          name: "Install chipmunk lib files"
          command: "wget 'http://archive.ubuntu.com/ubuntu/pool/universe/c/chipmunk/libchipmunk-dev_7.0.3-3_amd64.deb' && apt-get -y install ./libchipmunk-dev_7.0.3-3_amd64.deb"
      - run:
          name: "Install chipmunk dev files"
          command: "wget 'http://archive.ubuntu.com/ubuntu/pool/universe/c/chipmunk/chipmunk-dev_7.0.3-3_all.deb' && apt-get -y install ./chipmunk-dev_7.0.3-3_all.deb"
      - run:
          name: "Install sdl"
          command: "DEBIAN_FRONTEND='noninteractive' apt-get -y install libsdl2-dev"
      - run:
          name: "Install cmake"
          command: "apt-get -y install cmake"
      - run:
          name: "Clone sdl_gpu"
          command: "git clone git@github.com:grimfang4/sdl-gpu.git && cd sdl-gpu && git checkout '6df9944ccb344b9b0725b344fdfb201958eec90c'"
      - run:
          name: "Build sdl_gpu"
          command: "cd sdl-gpu && cmake -G 'Unix Makefiles' -DCMAKE_INSTALL_PREFIX=/usr && make && make install"
      - run:
          name: "Install nim package dependencies"
          command: "nimble install -dy"
      - run:
          name: "Build Shade"
          command: "nimble release"
      - run:
          name: "Run Tests"
          command: "nimble develop && nimble runtests"

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  ci:
    jobs:
      - build
